{#
  location.jinja2
  ---------------
  Wiki template for Location entity.
  Displays venue info, visit timeline, and people encountered.
#}
# Palimpsest — Location

## {{ entity.name }}

### Location Info
- **City:** {{ entity_link(entity.city, 'cities', wiki_dir, output_path) }}
- **Total Entries:** {{ entity.entry_count }}
- **Scenes:** {{ entity.scene_count }}

### Visit History
{% if entity.entries %}
{% set first_visit = entity.first_visit %}
{% set last_visit = entity.last_visit %}
{% if first_visit and last_visit %}
- **First Visit:** {{ first_visit.isoformat() }}
- **Last Visit:** {{ last_visit.isoformat() }}
{% endif %}
{% endif %}

### Timeline
{% if entity.entries %}
{% set sorted_entries = entity.entries|sort(attribute='date', reverse=true) %}
{% set current_year = namespace(value=0) %}
{% for entry in sorted_entries %}
{% if entry.date.year != current_year.value %}
{% set current_year.value = entry.date.year %}

#### {{ current_year.value }}

{% endif %}
- **{{ entry.date.isoformat() }}** — {{ entity_link(entry, 'entries', wiki_dir, output_path) }}
{% endfor %}
{% endif %}

### Scenes at This Location
{% if entity.scenes %}
{% for scene in entity.scenes|sort(attribute='entry.date', reverse=true) %}
- **{{ scene.name }}** ({{ scene.entry.date.isoformat() }}) — {{ scene.description[:80] }}{% if scene.description|length > 80 %}...{% endif %}
{% endfor %}
{% endif %}

### People Encountered
{% if entity.entries %}
{% set people_dict = {} %}
{% for entry in entity.entries %}
{% for person in entry.people %}
{% if person.display_name not in people_dict %}
{% set _ = people_dict.update({person.display_name: {'person': person, 'count': 0}}) %}
{% endif %}
{% set _ = people_dict[person.display_name].update({'count': people_dict[person.display_name].count + 1}) %}
{% endfor %}
{% endfor %}
{% for name, data in people_dict.items()|sort(attribute='1.count', reverse=true) %}
- {{ entity_link(data.person, 'people', wiki_dir, output_path) }} ({{ data.count }} visit{{ 's' if data.count != 1 else '' }})
{% endfor %}
{% endif %}
