{#
  location.jinja2
  ---------------
  Wiki template for Location entity.
  Displays venue info, visit timeline, and people encountered.
#}
# Palimpsest — Location

## {{ entity.name }}

### Location Info
- **City:** {{ entity_link(entity.city, 'cities', wiki_dir, output_path) }}
- **Total Visits:** {{ entity.visit_count }}

### Visit History
{% if entity.moments %}
{% set first_visit = entity.first_visit_date %}
{% set last_visit = entity.last_visit_date %}
{% if first_visit and last_visit %}
- **First Visit:** {{ first_visit.isoformat() }}
- **Last Visit:** {{ last_visit.isoformat() }}
- **Span:** {{ entity.visit_span_days }} days
{% endif %}
{% endif %}

### Timeline
{% if entity.moments %}
{% set sorted_moments = entity.moments|sort(attribute='date', reverse=true) %}
{% set current_year = namespace(value=0) %}
{% for moment in sorted_moments %}
{% if moment.date.year != current_year.value %}
{% set current_year.value = moment.date.year %}

#### {{ current_year.value }}

{% endif %}
{% set entry = moment.entries|first %}
- **{{ moment.date.isoformat() }}**{% if entry %} — {{ entity_link(entry, 'entries', wiki_dir, output_path) }}{% endif %}{% if moment.context %} — {{ moment.context }}{% endif %}

{% endfor %}
{% endif %}

### People Encountered
{% if entity.entries %}
{% set people_dict = {} %}
{% for entry in entity.entries %}
{% for person in entry.people %}
{% if person.display_name not in people_dict %}
{% set _ = people_dict.update({person.display_name: {'person': person, 'count': 0}}) %}
{% endif %}
{% set _ = people_dict[person.display_name].update({'count': people_dict[person.display_name].count + 1}) %}
{% endfor %}
{% endfor %}
{% for name, data in people_dict.items()|sort(attribute='1.count', reverse=true) %}
- {{ entity_link(data.person, 'people', wiki_dir, output_path) }} ({{ data.count }} visit{{ 's' if data.count != 1 else '' }})
{% endfor %}
{% endif %}

### Notes
{{ entity.notes or '[Add notes about this location for manuscript use]' }}
