{#
  person.jinja2
  -------------
  Wiki template for Person entity.
  Displays person metadata, appearances timeline, co-appearances,
  locations, scenes, threads, and notes.
#}
# Palimpsest — Person

## {{ entity.display_name }}

---

### Identity

| Attribute | Value |
|-----------|-------|
| **Name** | {{ entity.display_name }} |
| **Relationship** | {{ entity.relationship_display }} |
{% if entity.alias %}
| **Alias** | {{ entity.alias }} |
{% endif %}

---

### Presence in Journal

| Metric | Value |
|--------|-------|
| **Entries** | {{ entity.entries|length }} |
| **Scenes** | {{ entity.scene_count }} |
{% if entity.first_appearance and entity.last_appearance %}
| **First Appearance** | {{ entity.first_appearance|format_date }} |
| **Last Appearance** | {{ entity.last_appearance|format_date }} |
| **Span** | {{ ((entity.last_appearance - entity.first_appearance).days) }} days |
{% endif %}

---

{% if entity.entries|length > 0 %}
### Appearance Timeline

{% set entries_by_year = {} %}
{% for entry in entity.entries %}
{% set year = entry.date.year %}
{% if year not in entries_by_year %}
{% set _ = entries_by_year.update({year: []}) %}
{% endif %}
{% set _ = entries_by_year[year].append(entry) %}
{% endfor %}

{% for year in entries_by_year.keys()|sort(reverse=true) %}
**{{ year }}** ({{ entries_by_year[year]|length }} entries)
{% for entry in entries_by_year[year]|sort(attribute='date', reverse=true) %}
- [[entries/{{ year }}/{{ entry.date.isoformat() }}.md|{{ entry.date|format_date('%m-%d') }}]]{% if entry.word_count %} ({{ entry.word_count }} words){% endif %}

{% endfor %}
{% endfor %}
{% endif %}

---

{% if co_appearances %}
### Co-Appearances

People who appear together with {{ entity.display_name }}:

| Person | Shared Entries |
|--------|----------------|
{% for coapp in co_appearances[:10] %}
| [[people/{{ coapp.slug }}.md|{{ coapp.name }}]] | {{ coapp.count }} |
{% endfor %}
{% endif %}

---

{% if locations %}
### Locations

Places associated with {{ entity.display_name }}:

{% for loc in locations[:10] %}
- [[locations/{{ loc.city_slug }}/{{ loc.slug }}.md|{{ loc.name }}]] ({{ loc.city }}) — {{ loc.count }} scenes
{% endfor %}
{% endif %}

---

{% if entity.scenes %}
### Scenes

{% for scene in entity.scenes|sort(attribute='entry.date', reverse=true)[:15] %}
- **{{ scene.name }}** ({{ scene.entry.date.isoformat() }}) — {{ scene.description[:60] }}{% if scene.description|length > 60 %}...{% endif %}
{% endfor %}
{% if entity.scenes|length > 15 %}
*...and {{ entity.scenes|length - 15 }} more scenes*
{% endif %}
{% endif %}

---

{% if entity.threads %}
### Threads

Temporal connections involving {{ entity.display_name }}:

{% for thread in entity.threads|sort(attribute='from_date', reverse=true)[:10] %}
- **{{ thread.name }}** ({{ thread.from_date.isoformat() }} → {{ thread.to_date }}) — {{ thread.content[:60] }}{% if thread.content|length > 60 %}...{% endif %}
{% endfor %}
{% if entity.threads|length > 10 %}
*...and {{ entity.threads|length - 10 }} more threads*
{% endif %}
{% endif %}

---

### Themes

{% if entity.entries %}
{% set themes = [] %}
{% for entry in entity.entries %}
{% for theme in entry.themes %}
{% if theme.name not in themes %}
{% set _ = themes.append(theme.name) %}
{% endif %}
{% endfor %}
{% endfor %}
{% if themes %}
{% for theme in themes|sort %}
- {{ theme }}
{% endfor %}
{% else %}
*No themes tagged.*
{% endif %}
{% else %}
*No themes tagged.*
{% endif %}

---

### Character Mappings

{% if entity.character_mappings %}
{% for mapping in entity.character_mappings %}
- **{{ mapping.character.name }}** ({{ mapping.contribution.value }}){% if mapping.notes %} — {{ mapping.notes }}{% endif %}
{% endfor %}
{% else %}
*No manuscript characters based on this person.*
{% endif %}
